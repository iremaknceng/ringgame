<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Ring Gap Game</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>

  <style>
    body { margin: 0; overflow: hidden; background: black; }
    canvas { display: block; touch-action: none; }
  </style>
</head>
<body>
<script>
/* =========================
   ASSETS
========================= */
let bgImg;
let cursorImg;

/* =========================
   GAME STATE
========================= */
const State = { START: "start", PLAY: "play", GAMEOVER: "gameover" };
let state = State.START;

/* =========================
   GAME DATA
========================= */
const game = {
  score: 0,
  lives: 3,
  level: 1
};

/* =========================
   OBJECTS
========================= */
const ring = {
  radius: 80,
  gapRatio: 0.2,
  angle: 0,
  speed: 1.6,
  thickness: 5 // ✅ Halka kalınlığı 5
};

const ball = {
  x: 0,
  y: 0,
  r: 12,
  follow: 0.18
};

/* =========================
   FLAGS
========================= */
let prevPass = false;
let prevHit = false;

/* =========================
   PRELOAD
========================= */
function preload() {
  // background.jpg yoksa oyun yine çalışır (siyah arka plan olur)
  bgImg = loadImage("assets/background.jpg", () => {}, () => {});
  
  // ✅ Top yerine çizilecek PNG: assets/mouse.png
  cursorImg = loadImage(
    "assets/mouse.png",
    () => console.log("mouse.png yüklendi"),
    () => console.log("mouse.png YÜKLENEMEDİ (isim/yol kontrol et)")
  );
}

/* =========================
   SETUP
========================= */
function setup() {
  createCanvas(windowWidth, windowHeight);
  frameRate(60);

  // ✅ Sistem imleci gizli, PNG imleç çiziyoruz
  noCursor();
  imageMode(CENTER);
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
}

/* =========================
   INPUT
========================= */
function touchStarted() { handlePress(); return false; }
function mousePressed() { handlePress(); return false; }
function touchMoved() { return false; }

function handlePress() {
  if (state !== State.PLAY) startGame();
}

function startGame() {
  state = State.PLAY;
  game.score = 0;
  game.lives = 3;
  game.level = 1;

  ring.angle = 0;
  ball.x = 0;
  ball.y = 0;

  prevPass = false;
  prevHit = false;
}

/* =========================
   MAIN LOOP
========================= */
function draw() {
  const dt = deltaTime / 1000;
  update(dt);
  render();
}

/* =========================
   UPDATE
========================= */
function update(dt) {
  ring.radius = min(width, height) / 6;
  ball.r = ring.radius / 3;

  if (state !== State.PLAY) return;

  game.level = 1 + floor(game.score / 5);
  ring.speed = 1.4 + game.level * 0.25;
  ring.gapRatio = constrain(0.22 - game.level * 0.015, 0.08, 0.22);
  ring.angle = (ring.angle + ring.speed * dt) % TWO_PI;

  /* ✅ Mouse algılama noktası ~4mm SOLDA */
  const OFFSET_MM = 4;
  const PX_PER_MM = 3.78; // ~96 DPI varsayımı
  const offsetPx = OFFSET_MM * PX_PER_MM;

  const targetX = (mouseX - offsetPx) - width / 2;
  const targetY = mouseY - height / 2;

  ball.x = lerp(ball.x, targetX, ball.follow);
  ball.y = lerp(ball.y, targetY, ball.follow);

  // Collision logic
  const d = sqrt(ball.x * ball.x + ball.y * ball.y);
  let ang = atan2(ball.y, ball.x);
  if (ang < 0) ang += TWO_PI;

  const relAng = (ang - ring.angle + TWO_PI) % TWO_PI;
  const arcAng = TWO_PI * (1 - ring.gapRatio);
  const inGap = relAng > arcAng;

  const nearRing = abs(d - ring.radius) < ball.r;

  if (!prevPass && inGap && nearRing) game.score++;

  if (!prevHit && !inGap && nearRing) {
    game.lives--;
    if (game.lives <= 0) state = State.GAMEOVER;
  }

  prevPass = inGap && nearRing;
  prevHit = !inGap && nearRing;
}

/* =========================
   RENDER
========================= */
function render() {
  resetMatrix();

  if (bgImg) image(bgImg, 0, 0, width, height);
  else background(0);

  // arka planı hafif karart
  fill(0, 150);
  noStroke();
  rect(0, 0, width, height);

  translate(width / 2, height / 2);

  // Ring
  push();
  rotate(ring.angle);
  noFill();
  stroke(255);
  strokeWeight(ring.thickness); // ✅ 5 kalınlık
  arc(0, 0, ring.radius * 2, ring.radius * 2, 0, TWO_PI * (1 - ring.gapRatio));
  pop();

  // ✅ TOP YERİNE MOUSE PNG (boyut yarı: 14px)
  if (cursorImg) {
    const CURSOR_SIZE = 14; // ✅ yarıya düşürülmüş boyut
    image(cursorImg, ball.x, ball.y, CURSOR_SIZE, CURSOR_SIZE);
  }

  // HUD
  resetMatrix();
  fill(255);
  textSize(20);
  text(`Score: ${game.score}`, 20, 40);
  text(`Lives: ${game.lives}`, 20, 70);
  text(`Level: ${game.level}`, 20, 100);

  if (state === State.START) {
    textSize(26);
    text("Click/Tap to Start", 20, 150);
  } else if (state === State.GAMEOVER) {
    textSize(28);
    text("GAME OVER", 20, 150);
    textSize(20);
    text("Click/Tap to Restart", 20, 180);
  }
}
</script>
</body>
</html>


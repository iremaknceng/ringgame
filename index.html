<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Ring Gap Game</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>

  <style>
    body { margin: 0; overflow: hidden; background: black; }
    canvas { display: block; touch-action: none; }

    /* ✅ Video overlay */
    #introVideo {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      display: none;       /* başlangıçta gizli */
      z-index: 10;
      background: black;
    }
  </style>
</head>
<body>

<!-- ✅ HTML Video (sesli) -->
<video id="introVideo" src="assets/intro.mp4" playsinline webkit-playsinline></video>

<script>
/* =========================
   ASSETS (p5)
========================= */
let bgImg;
let cursorImg;

/* =========================
   HTML VIDEO
========================= */
let vidEl;
let introStartedAt = 0;
const INTRO_MS = 7000;

/* =========================
   GAME STATE
========================= */
const State = {
  INTRO: "intro",   // play butonu ekranı
  PLAY: "play",
  GAMEOVER: "gameover"
};
let state = State.INTRO;

/* =========================
   GAME DATA
========================= */
const game = { score: 0, lives: 3, level: 1 };

/* =========================
   OBJECTS
========================= */
const ring = {
  radius: 80,
  gapRatio: 0.2,
  angle: 0,
  speed: 1.6,
  thickness: 5
};

const ball = { x: 0, y: 0, r: 12, follow: 0.18 };

/* =========================
   FLAGS
========================= */
let prevPass = false;
let prevHit  = false;

/* =========================
   PLAY BUTTON GEOMETRY
========================= */
function getPlayButton() {
  const cx = width / 2;
  const cy = height / 2;
  const R  = min(width, height) * 0.07; // buton büyüklüğü
  return { cx, cy, R };
}

function isInsidePlayButton(px, py) {
  const { cx, cy, R } = getPlayButton();
  const dx = px - cx, dy = py - cy;
  return (dx*dx + dy*dy) <= (R*R);
}

/* =========================
   PRELOAD
========================= */
function preload() {
  bgImg = loadImage("assets/background.jpg", () => {}, () => {});
  cursorImg = loadImage("assets/mouse.png", () => {}, () => {});
}

/* =========================
   SETUP
========================= */
function setup() {
  createCanvas(windowWidth, windowHeight);
  frameRate(60);
  noCursor();
  imageMode(CENTER);

  // HTML video element
  vidEl = document.getElementById("introVideo");

  // Video biterse de oyuna geç (yedek)
  vidEl.addEventListener("ended", () => finishIntro());

  // Hata olursa konsola yaz
  vidEl.addEventListener("error", () => {
    console.log("Video load error: assets/intro.mp4 yolu/ismi doğru mu?");
  });
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
}

/* =========================
   INPUT
========================= */
function mousePressed() { handlePress(mouseX, mouseY); return false; }
function touchStarted() {
  const t = touches[0] || { x: mouseX, y: mouseY };
  handlePress(t.x, t.y);
  return false;
}

function handlePress(px, py) {
  if (state === State.INTRO) {
    if (isInsidePlayButton(px, py)) startIntroVideo();
    return;
  }
  if (state === State.GAMEOVER) startGame();
}

/* =========================
   INTRO VIDEO START
========================= */
async function startIntroVideo() {
  // Video görünür yap
  vidEl.style.display = "block";

  // Sesli başlatmak için muted=false
  vidEl.muted = false;
  vidEl.volume = 1;

  // Baştan sar
  try { vidEl.currentTime = 0; } catch(e) {}

  // ✅ user gesture içinde play -> sesli çalışır
  try {
    const p = vidEl.play();
    if (p && p.catch) await p;
    introStartedAt = millis();
    // 7 sn sonra bitir
    setTimeout(finishIntro, INTRO_MS);
  } catch (err) {
    // Eğer tarayıcı engellerse (nadir), sessiz başlatıp hemen tekrar deneyebiliriz
    console.log("play blocked:", err);
  }
}

function finishIntro() {
  // Bir kere çalışsın
  if (state !== State.INTRO) return;

  // Video gizle/durdur
  try { vidEl.pause(); } catch(e) {}
  vidEl.style.display = "none";

  // Oyunu başlat
  startGame();
}

/* =========================
   START GAME
========================= */
function startGame() {
  state = State.PLAY;
  game.score = 0;
  game.lives = 3;
  game.level = 1;
  ring.angle = 0;
  ball.x = 0;
  ball.y = 0;
  prevPass = false;
  prevHit = false;
}

/* =========================
   MAIN LOOP
========================= */
function draw() {
  if (state === State.INTRO) {
    renderIntroScreen();
    return;
  }

  const dt = deltaTime / 1000;
  update(dt);
  renderGame();
}

/* =========================
   INTRO RENDER (triangle button)
========================= */
function renderIntroScreen() {
  background(0);

  // Yazı
  fill(255);
  textAlign(CENTER, CENTER);
  textSize(26);
  text("Click to Watch", width/2, height/2 - 90);

  textSize(14);
  text("The video will play with sound for 7 seconds.", width/2, height/2 - 60);

  // Play butonu
  const { cx, cy, R } = getPlayButton();

  // daire
  noFill();
  stroke(255);
  strokeWeight(3);
  circle(cx, cy, R*2);

  // üçgen
  noStroke();
  fill(255);
  const triW = R * 0.85;
  const triH = R * 0.95;
  // sağa bakan üçgen
  triangle(
    cx - triW*0.35, cy - triH*0.55,
    cx - triW*0.35, cy + triH*0.55,
    cx + triW*0.65, cy
  );

  // küçük not
  fill(180);
  textSize(12);
  text("Click the play button", width/2, height/2 + R + 22);
}

/* =========================
   UPDATE
========================= */
function update(dt) {
  ring.radius = min(width, height) / 6;
  ball.r = ring.radius / 3;

  if (state !== State.PLAY) return;

  game.level = 1 + floor(game.score / 5);
  ring.speed = 1.4 + game.level * 0.25;
  ring.gapRatio = constrain(0.22 - game.level * 0.015, 0.08, 0.22);
  ring.angle = (ring.angle + ring.speed * dt) % TWO_PI;

  // ~4mm sola offset
  const offsetPx = 4 * 3.78;
  const targetX = (mouseX - offsetPx) - width/2;
  const targetY = mouseY - height/2;

  ball.x = lerp(ball.x, targetX, ball.follow);
  ball.y = lerp(ball.y, targetY, ball.follow);

  // collision
  const d = sqrt(ball.x*ball.x + ball.y*ball.y);
  let ang = atan2(ball.y, ball.x);
  if (ang < 0) ang += TWO_PI;

  const relAng = (ang - ring.angle + TWO_PI) % TWO_PI;
  const arcAng = TWO_PI * (1 - ring.gapRatio);
  const inGap = relAng > arcAng;
  const nearRing = abs(d - ring.radius) < ball.r;

  if (!prevPass && inGap && nearRing) game.score++;
  if (!prevHit && !inGap && nearRing) {
    game.lives--;
    if (game.lives <= 0) state = State.GAMEOVER;
  }

  prevPass = inGap && nearRing;
  prevHit  = !inGap && nearRing;
}

/* =========================
   RENDER GAME
========================= */
function renderGame() {
  resetMatrix();

  if (bgImg) image(bgImg, 0, 0, width, height);
  else background(0);

  fill(0, 150);
  noStroke();
  rect(0, 0, width, height);

  translate(width/2, height/2);

  // ring
  push();
  rotate(ring.angle);
  noFill();
  stroke(255);
  strokeWeight(ring.thickness);
  arc(0,0, ring.radius*2, ring.radius*2, 0, TWO_PI*(1 - ring.gapRatio));
  pop();

  // mouse png (20px)
  if (cursorImg) image(cursorImg, ball.x, ball.y, 20, 20);

  // HUD
  resetMatrix();
  fill(255);
  textSize(20);
  text(`Score: ${game.score}`, 20, 40);
  text(`Lives: ${game.lives}`, 20, 70);
  text(`Level: ${game.level}`, 20, 100);

  if (state === State.GAMEOVER) {
    textSize(28);
    text("GAME OVER", 20, 150);
    textSize(20);
    text("Click to Restart", 20, 180);
  }
}
</script>
</body>
</html>
